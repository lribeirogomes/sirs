OPENSSL=OPENSSLopensslCNF=OPENSSLopensslCNFopenssl.cnf
CA=CA${OPENSSL} ca -config ${CNF}
REQ=REQ${OPENSSL} req -config ${CNF}

KEY=KEYprivate/cakey.pem
KEYMODE=KEYMODERSA
CACERT=CACERTcacert.pem
CADAYS=CADAYS3650

CRL=CRLcrl.pem
INDEX=INDEXindex.txt
SERIAL=SERIALserial


CADEPS=CADEPS${CNF} ${KEY} ${CACERT}

all:all${CRL}

${CRL}:CRL${CADEPS}
	${CA} -gencrl -out ${CRL}

${CACERT}: ${CNF} ${KEY}
	${REQ} -key ${KEY} -x509 -new -days ${CADAYS} -out ${CACERT}
	rm -f ${INDEX}
	touch ${INDEX}
	echo 100001 > ${SERIAL}

${KEY}: ${CNF}
	mkdir -m0700 -p $(dir ${KEY})
	touch ${KEY}
	chmod 0600 ${KEY}
	${OPENSSL} genpkey -algorithm ${KEYMODE} -out ${KEY}


revoke:revoke${CADEPS} ${item}
	@test -n $${item:?'usage: ${MAKE} revoke item=cert.pem'}
	${CA} -revoke ${item}
	${MAKE} ${CRL}

sign:sign${CADEPS} ${item}
	@test -n $${item:?'usage: ${MAKE} sign item=request.csr'}
	mkdir -p newcerts
	${CA} -in ${item} -out ${item:.csr=.crt} 

